---
    name: Build and Publish ClamAV Image
    on:
        # schedule:
        #   - cron: '0 4 * * 0'
        workflow_dispatch:

    env:
      DOCKER_NAME: clamav-rest
      IMAGE: clamav
      GH_REPO: asteel-gsa/clamav-rest

    jobs:
      build-clamav:
        runs-on: ubuntu-latest
        permissions:
          contents: read
          packages: write
        steps:
          - name: Get Date
            shell: bash
            id: date
            run: |
              echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

          - name: Checkout Repository
            uses: actions/checkout@v3

          # - name: Set up Docker Buildx
          #   uses: docker/setup-buildx-action@v2

          - name: Build Docker Image
            run: docker build . -t ${{ env.DOCKER_NAME }}:${{ steps.date.outputs.date }}
            # clamav-rest:20230525

          # - name: Scan Image
          #   run: docker run aquasec/trivy:latest  image --timeout 5m --scanners vuln --exit-code 1 --severity CRITICAL,HIGH ${{ env.DOCKER_NAME }}:${{ steps.date.outputs.date }}

          - name: Tag Image
            run: |
              image_creation_date=$(date -d "$(docker inspect -f '{{ .Created }}' ${{ env.DOCKER_NAME }}:${{ steps.date.outputs.date }})" +%s)
              docker tag ${{ env.DOCKER_NAME }}:${{ steps.date.outputs.date }} ghcr.io/${{ env.GH_REPO }}/${{ env.IMAGE }}:${{ steps.date.outputs.date }}
              docker tag ${{ env.DOCKER_NAME }}:${{ steps.date.outputs.date }} ghcr.io/${{ env.GH_REPO }}/${{ env.IMAGE }}:$image_creation_date

          - name: Login to GitHub Container Registry
            uses: docker/login-action@v2
            with:
              registry: ghcr.io
              username: ${{ github.repository_owner }}
              password: ${{ secrets.GITHUB_TOKEN }}

          - name: Push Image
            run: docker push --all-tags ghcr.io/${{ env.GH_REPO }}/${{ env.IMAGE }}
