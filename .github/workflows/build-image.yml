---
    name: Build and Publish ClamAV Image
    on:
        workflow_dispatch:
        workflow_call:

    env:
      DOCKER_NAME: clamav-rest
      IMAGE: clamav
      GH_REPO: asteel-gsa/clamav-rest

    jobs:
      build-clamav:
        runs-on: ubuntu-latest
        permissions:
          contents: read
          packages: write
        steps:
          - name: Get Date
            shell: bash
            id: date
            run: |
              echo "date=$(date +%Y%m%d)" >> $GITHUB_OUTPUT

          - name: Checkout Repository
            uses: actions/checkout@v3

          - name: Build Docker Image
            run: docker build . -t ${{ env.DOCKER_NAME }}:${{ steps.date.outputs.date }}
            # clamav-rest:20230525

          - name: Tag Image
            run: |
              docker tag ${{ env.DOCKER_NAME }}:${{ steps.date.outputs.date }} ghcr.io/${{ env.GH_REPO }}/${{ env.IMAGE }}:${{ steps.date.outputs.date }}

          - name: Login to GitHub Container Registry
            uses: docker/login-action@v2
            with:
              registry: ghcr.io
              username: ${{ github.repository_owner }}
              password: ${{ secrets.GITHUB_TOKEN }}

          - name: Push Image
            run: docker push --all-tags ghcr.io/${{ env.GH_REPO }}/${{ env.IMAGE }}

          - name: Upload Artifact
            uses: ishworkh/docker-image-artifact-upload@v1
            with:
              image: "${{ env.DOCKER_NAME }}:${{ steps.date.outputs.date }}"
              retention_days: "8"
